<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>TGFX Playground</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎨</text></svg>">
  <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
  <style>
    :root { --bg:#1e1e1e; --panel:#252526; --line:#3c3c3c; --text:#d4d4d4; --primary:#0e639c; }
    html,body { height:100%; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Droid Sans',sans-serif; }
    .container { display:flex; flex-direction:column; height:100%; }
    .header { padding:10px 16px; border-bottom:1px solid var(--line); background:#1f1f1f; }
    .content { display:flex; flex:1; min-height:0; }
    .editor-panel, .output-panel { flex:1; display:flex; flex-direction:column; min-width:0; }
    .editor-panel { border-right:1px solid var(--line); background:var(--panel); }
    .bar { display:flex; align-items:center; gap:8px; padding:8px 12px; border-bottom:1px solid var(--line); background:#2d2d2d; flex-wrap: wrap; }
    .example-btn, .run-button {
      background:var(--primary); color:#fff; border:1px solid var(--primary);
      padding:6px 10px; border-radius:2px; font-size:12px; cursor:pointer;
    }
    .example-btn:hover, .run-button:hover { filter:brightness(1.1); }
    .run-button:disabled { background:#3c3c3c; border-color:#3c3c3c; color:#999; cursor:not-allowed; }
    #monacoEditor { flex:1; min-height:0; }
    .canvas-wrap { flex:1; display:flex; align-items:center; justify-content:center; padding:12px; border-bottom:1px solid var(--line); background:var(--panel); min-height:0; }
    canvas { background:#111; border:1px solid var(--line); }
    .console { height:160px; padding:10px; font:12px/1.5 Consolas, 'Courier New', monospace; background:#111; overflow:auto; border-top:1px solid var(--line); white-space:pre-wrap; }
    .info { color:#4fc1ff; } .success { color:#6a9955; } .error { color:#f14c4c; } .warning { color:#cca700; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><h2 style="margin:0">TGFX Playground</h2></div>

    <div class="content">
      <div class="editor-panel">
        <div class="bar" id="examplesBar">
          <button class="example-btn" data-example="path">Path</button>
          <button class="example-btn" data-example="blendMode">BlendMode</button>
          <button class="example-btn" data-example="colorfilter">ColorFilter</button>
          <button class="example-btn" data-example="imagefilter">ImageFilter</button>
          <button class="example-btn" data-example="mask">Mask</button>
          <button class="example-btn" data-example="layer">Layer</button>
          <button class="example-btn" data-example="image">Image</button>
          <button class="example-btn" data-example="text">Text</button>
          <button class="example-btn" data-example="emoji">Emoji</button>
          <button class="example-btn" data-example="svg">SVG</button>
        </div>
        <div class="bar">
          <div style="flex:1;font-weight:600">C++ 代码</div>
          <button id="runBtn" class="run-button">▶️ 运行</button>
        </div>
        <div id="monacoEditor"></div>
      </div>

      <div class="output-panel">
        <div class="canvas-wrap">
          <canvas id="renderCanvas" width="640" height="480"></canvas>
        </div>
        <div id="console" class="console"></div>
      </div>
    </div>
  </div>

  <script type="module">
    let monacoEditor = null;
    let compilationManager = null;
    let currentExample = 'path';

    function log(msg, type='info'){
      const c = document.getElementById('console');
      const span = document.createElement('span');
      span.className = type;
      span.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      c.appendChild(span);
      c.scrollTop = c.scrollHeight;
    }

    // 标准 API 示例：默认 path
    const defaultCode = `#include <tgfx/core/Color.h>
#include <tgfx/core/Paint.h>
#include <tgfx/core/Rect.h>
#include <tgfx/core/Canvas.h>
#include <tgfx/core/Path.h>
#include <tgfx/gpu/opengl/webgl/WebGLWindow.h>

using namespace tgfx;

int main(){
  auto window = WebGLWindow::MakeFrom("#renderCanvas");
  if(!window) return 1;
  auto device = window->getDevice(); if(!device) return 2;
  auto context = device->lockContext(); if(!context) return 3;
  auto surface = window->getSurface(context); if(!surface) return 4;
  auto canvas = surface->getCanvas();

  canvas->clear(Color::White());

  // 填充三角形轮廓（用 Path + drawPath）
  Path tri;
  tri.moveTo(60,60);
  tri.lineTo(180,60);
  tri.lineTo(120,140);
  tri.close();

  Paint fill; fill.setColor(Color::FromRGBA(255,165,0,220));
  canvas->drawPath(tri, fill);

  // 外轮廓描边
  Paint stroke; stroke.setStyle(PaintStyle::Stroke);
  stroke.setStrokeWidth(3.0f);
  stroke.setColor(Color::FromRGBA(30,144,255,255));
  canvas->drawPath(tri, stroke);

  window->present(context);
  return 0;
}`;

    // 10 个标准 API 示例
    const examples = {
      path: defaultCode,

      blendMode: `#include <tgfx/core/Color.h>
#include <tgfx/core/Paint.h>
#include <tgfx/core/Canvas.h>
#include <tgfx/core/BlendMode.h>
#include <tgfx/gpu/opengl/webgl/WebGLWindow.h>
using namespace tgfx;

int main(){
  auto window = WebGLWindow::MakeFrom("#renderCanvas");
  if(!window) return 1;
  auto device = window->getDevice(); if(!device) return 2;
  auto context = device->lockContext(); if(!context) return 3;
  auto surface = window->getSurface(context); if(!surface) return 4;
  auto canvas = surface->getCanvas();
  canvas->clear(Color::White());

  // 多混合模式对照
  const BlendMode modes[] = {
    BlendMode::SrcOver, BlendMode::Multiply, BlendMode::Screen,
    BlendMode::Overlay, BlendMode::SoftLight, BlendMode::Darken,
    BlendMode::Lighten
  };
  const int count = (int)(sizeof(modes)/sizeof(modes[0]));
  const int cols = 3;
  const float cellW = 200.0f, cellH = 150.0f;
  const float startX = 40.0f, startY = 40.0f;

  for(int i=0;i<count;i++){
    int r = i / cols, c = i % cols;
    canvas->save();
    canvas->translate(startX + c * cellW, startY + r * cellH);

    Paint p1; p1.setColor(Color::FromRGBA(255,0,0,180));
    Paint p2; p2.setColor(Color::FromRGBA(0,0,255,180));
    p2.setBlendMode(modes[i]);

    canvas->drawCircle(60,60, 50, p1);
    canvas->drawCircle(100,60, 50, p2);

    canvas->restore();
  }

  window->present(context);
  return 0;
}`,

      colorfilter: `#include <tgfx/core/Color.h>
#include <tgfx/core/Paint.h>
#include <tgfx/core/Canvas.h>
#include <tgfx/core/Rect.h>
#include <tgfx/core/ColorFilter.h>
#include <tgfx/gpu/opengl/webgl/WebGLWindow.h>
using namespace tgfx;

int main(){
  auto window = WebGLWindow::MakeFrom("#renderCanvas");
  if(!window) return 1;
  auto device = window->getDevice(); if(!device) return 2;
  auto context = device->lockContext(); if(!context) return 3;
  auto surface = window->getSurface(context); if(!surface) return 4;
  auto canvas = surface->getCanvas();
  canvas->clear(Color::White());

  // 矩阵颜色滤镜（降低绿色，提升蓝色）
  std::array<float,20> mat = {
    1,0,0,0,0,
    0,0.7f,0,0,0,
    0,0,1.3f,0,0,
    0,0,0,1,0
  };
  Paint p; p.setColor(Color::FromRGBA(120,180,220,255));
  p.setColorFilter(ColorFilter::Matrix(mat));
  canvas->drawRect(Rect::MakeLTRB(60,60,300,180), p);

  window->present(context);
  return 0;
}`,

      imagefilter: `#include <tgfx/core/Color.h>
#include <tgfx/core/Paint.h>
#include <tgfx/core/Canvas.h>
#include <tgfx/core/Rect.h>
#include <tgfx/core/Image.h>
#include <tgfx/core/ImageFilter.h>
#include <tgfx/core/SamplingOptions.h>
#include <tgfx/gpu/opengl/webgl/WebGLWindow.h>
using namespace tgfx;

int main(){
  auto window = WebGLWindow::MakeFrom("#renderCanvas");
  if(!window) return 1;
  auto device = window->getDevice(); if(!device) return 2;
  auto context = device->lockContext(); if(!context) return 3;
  auto surface = window->getSurface(context); if(!surface) return 4;
  auto canvas = surface->getCanvas();
  canvas->clear(Color::White());

  // 直接使用 MakeFromFile 加载图片
  auto img = Image::MakeFromFile("/working/assets/image.webp");
  if(img) {
    // 在滤镜里做高斯模糊
    Paint p; p.setImageFilter(ImageFilter::Blur(8.0f, 8.0f));
    // 使用 saveLayer 应用滤镜到其间绘制的内容
    canvas->saveLayer(&p);
    canvas->drawImageRect(img, Rect::MakeLTRB(60,60,380,260), SamplingOptions{});
    canvas->restore();
  }

  window->present(context);
  return 0;
}`,

      mask: `#include <tgfx/core/Color.h>
#include <tgfx/core/Paint.h>
#include <tgfx/core/Canvas.h>
#include <tgfx/core/Path.h>
#include <tgfx/core/Rect.h>
#include <tgfx/gpu/opengl/webgl/WebGLWindow.h>
using namespace tgfx;

int main(){
  auto window = WebGLWindow::MakeFrom("#renderCanvas");
  if(!window) return 1;
  auto device = window->getDevice(); if(!device) return 2;
  auto context = device->lockContext(); if(!context) return 3;
  auto surface = window->getSurface(context); if(!surface) return 4;
  auto canvas = surface->getCanvas();
  canvas->clear(Color::White());

  // 使用 clipPath 作为遮罩区域（标准 API）
  Path clip;
  clip.addOval(Rect::MakeLTRB(140,80,340,280)); // 椭圆作为遮罩
  canvas->clipPath(clip);

  // 在遮罩区域中绘制
  Paint bg; bg.setColor(Color::FromRGBA(30,144,255,255));
  canvas->drawRect(Rect::MakeLTRB(80,60,400,300), bg);

  Paint fg; fg.setColor(Color::FromRGBA(255,255,255,200));
  fg.setStyle(PaintStyle::Stroke);
  fg.setStrokeWidth(6.0f);
  canvas->drawOval(Rect::MakeLTRB(140,80,340,280), fg);

  window->present(context);
  return 0;
}`,

      layer: `#include <tgfx/core/Color.h>
#include <tgfx/core/Paint.h>
#include <tgfx/core/Canvas.h>
#include <tgfx/core/Rect.h>
#include <tgfx/core/BlendMode.h>
#include <tgfx/core/ImageFilter.h>
#include <tgfx/gpu/opengl/webgl/WebGLWindow.h>
using namespace tgfx;

int main(){
  auto window  = WebGLWindow::MakeFrom("#renderCanvas");
  if(!window) return 1;
  auto device  = window->getDevice();      if(!device) return 2;
  auto context = device->lockContext();    if(!context) return 3;
  auto surface = window->getSurface(context); if(!surface) return 4;
  auto canvas  = surface->getCanvas();

  // 背景：棋盘格，便于观察图层混合效果
  canvas->clear(Color::White());
  const float cell = 40.f;
  Paint bg1; bg1.setColor(Color::FromRGBA(235,235,235,255));
  Paint bg2; bg2.setColor(Color::FromRGBA(210,210,210,255));
  for(int y=0;y<12;y++){
    for(int x=0;x<16;x++){
      bool dark = ((x+y)&1);
      canvas->drawRect(Rect::MakeLTRB(x*cell, y*cell, (x+1)*cell, (y+1)*cell), dark?bg2:bg1);
    }
  }

  // 图层：对组内内容应用模糊；合成到背景时使用统一的乘色混合和透明度
  Paint layerPaint;
  layerPaint.setImageFilter(ImageFilter::Blur(10.f, 10.f));
  layerPaint.setBlendMode(BlendMode::Multiply); // 组整体的混合模式
  layerPaint.setAlpha(0.8f);                    // 组整体透明度 [0..1]

  canvas->saveLayer(&layerPaint);
  {
    // 组内内容（普通绘制，不直接对背景生效）
    Paint p1; p1.setColor(Color::FromRGBA(255,120,0,255));
    Paint p2; p2.setColor(Color::FromRGBA(0,140,255,255));
    Paint p3; p3.setColor(Color::FromRGBA(60,200,120,255));

    canvas->drawRect(Rect::MakeLTRB(80,80, 300,220), p1);
    canvas->drawRect(Rect::MakeLTRB(180,140, 420,300), p2);
    canvas->drawCircle(420,140, 70, p3);
  }
  canvas->restore();

  window->present(context);
  return 0;
}
`,

      text: `#include <tgfx/core/Color.h>
#include <tgfx/core/Paint.h>
#include <tgfx/core/Canvas.h>
#include <tgfx/core/Font.h>
#include <tgfx/core/Typeface.h>
#include <tgfx/gpu/opengl/webgl/WebGLWindow.h>
using namespace tgfx;

int main(){
  auto window = WebGLWindow::MakeFrom("#renderCanvas");
  if(!window) return 1;
  auto device = window->getDevice(); if(!device) return 2;
  auto context = device->lockContext(); if(!context) return 3;
  auto surface = window->getSurface(context); if(!surface) return 4;
  auto canvas = surface->getCanvas();
  canvas->clear(Color::White());

  // 字体已在运行前写入到 /working/assets/NotoSansSC-Regular.otf
  auto tf = Typeface::MakeFromPath("/working/assets/NotoSansSC-Regular.otf");
  Font font(tf, 28.0f);

  Paint p; p.setColor(Color::FromRGBA(30,30,30,255));
  canvas->drawSimpleText("Hello, TGFX!", 80, 140, font, p);

  window->present(context);
  return 0;
}`,

      emoji: `#include <tgfx/core/Color.h>
#include <tgfx/core/Paint.h>
#include <tgfx/core/Canvas.h>
#include <tgfx/core/Font.h>
#include <tgfx/core/Typeface.h>
#include <tgfx/gpu/opengl/webgl/WebGLWindow.h>
using namespace tgfx;

int main(){
  auto window = WebGLWindow::MakeFrom("#renderCanvas");
  if(!window) return 1;
  auto device = window->getDevice(); if(!device) return 2;
  auto context = device->lockContext(); if(!context) return 3;
  auto surface = window->getSurface(context); if(!surface) return 4;
  auto canvas = surface->getCanvas();
  canvas->clear(Color::White());

  // 彩色 Emoji 字体（已写入 /working/assets/NotoColorEmoji.ttf）
  auto emojiTF = Typeface::MakeFromPath("/working/assets/NotoColorEmoji.ttf");
  Font emojiFont(emojiTF, 48.0f);

  Paint p; p.setColor(Color::FromRGBA(0,0,0,255)); // 对彩色字形通常不生效，但不影响
  canvas->drawSimpleText("Hello 😄🎉 TGFX", 60, 160, emojiFont, p);

  window->present(context);
  return 0;
}`,

      image: `#include <tgfx/core/Color.h>
#include <tgfx/core/Paint.h>
#include <tgfx/core/Canvas.h>
#include <tgfx/core/Rect.h>
#include <tgfx/core/Image.h>
#include <tgfx/core/SamplingOptions.h>
#include <tgfx/gpu/opengl/webgl/WebGLWindow.h>
using namespace tgfx;

int main(){
  auto window = WebGLWindow::MakeFrom("#renderCanvas");
  if(!window) return 1;
  auto device = window->getDevice(); if(!device) return 2;
  auto context = device->lockContext(); if(!context) return 3;
  auto surface = window->getSurface(context); if(!surface) return 4;
  auto canvas = surface->getCanvas();
  canvas->clear(Color::White());

  auto img = Image::MakeFromFile("/working/assets/image.webp");
  if(img) {
    Rect dst = Rect::MakeLTRB(60,60,380,260);
    canvas->drawImageRect(img, dst, SamplingOptions{}, nullptr);
  }

  window->present(context);
  return 0;
}`,

      svg: `#include <tgfx/core/Color.h>
#include <tgfx/core/Canvas.h>
#include <tgfx/core/Stream.h>
#include <tgfx/core/Size.h>
#include <tgfx/svg/SVGDOM.h>
#include <tgfx/gpu/opengl/webgl/WebGLWindow.h>
using namespace tgfx;

int main(){
auto window = WebGLWindow::MakeFrom("#renderCanvas");
if(!window) return 1;
auto dev = window->getDevice(); if(!dev) return 2;
auto ctx = dev->lockContext(); if(!ctx) return 3;
auto surface = window->getSurface(ctx); if(!surface) return 4;
auto canvas = surface->getCanvas();
canvas->clear(Color::White());

  auto stream = Stream::MakeFromFile("/working/assets/sample.svg");
  if (stream) {
    auto dom = SVGDOM::Make(*stream);
    if (dom) {
      dom->setContainerSize(Size{640, 480});
      dom->render(canvas);
    } else {
      printf("SVGDOM creation failed\\n");
    }
  }

window->present(ctx);
return 0;
}`
    };

    function initMonaco(){
      return new Promise((resolve, reject) => {
        require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.44.0/min/vs' } });
        require(['vs/editor/editor.main'], function(){
          try{
            monacoEditor = monaco.editor.create(document.getElementById('monacoEditor'), {
              value: defaultCode, language:'cpp', theme:'vs-dark', fontSize:14,
              minimap:{enabled:true}, automaticLayout:true, wordWrap:'on'
            });
            monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runCode);
            log('Monaco Editor 就绪','success');
            resolve();
          }catch(e){ log(`Monaco 初始化失败: ${e.message}`,'error'); reject(e); }
        });
      });
    }

    async function ensureManager(){
      if (compilationManager) return;
      const { default: CompilationManager } = await import('./compilation-manager.js');
      compilationManager = new CompilationManager();
      await compilationManager.initialize();
      log('编译器就绪','success');
    }

    async function runCode(){
      const btn = document.getElementById('runBtn');
      btn.disabled = true; btn.textContent = '执行中...';
      try{
        await ensureManager();
        const code = monacoEditor ? monacoEditor.getValue() : '';
        log('开始编译与执行...','info');
        const result = await compilationManager.compileAndExecute(code);
        if (result?.success) log('执行完成','success');
      }catch(e){
        log(`执行错误: ${e.message}`,'error');
      }finally{
        btn.disabled = false; btn.textContent = '▶️ 运行';
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await initMonaco();
      document.getElementById('runBtn').addEventListener('click', runCode);
      document.getElementById('examplesBar').addEventListener('click', (ev) => {
        const btn = ev.target.closest('[data-example]'); if(!btn) return;
        const key = btn.getAttribute('data-example');
        if (examples[key] && monacoEditor) {
          currentExample = key;
          monacoEditor.setValue(examples[key]);
          log(`已加载示例: ${key}`,'info');
        }
      });
      log('欢迎使用 TGFX 在线代码编辑器。Ctrl/Cmd+Enter 运行','info');
    });
  </script>
</body>
</html>
