openharmony:
  runs-on: macos-latest
  steps:
    - name: Check Out Repo
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Get Third-Party Cache
      id: third-party-cache
      uses: actions/cache/restore@v4
      with:
        path: third_party
        key: third-party-openharmony-${{ hashFiles('DEPS') }}-${{ hashFiles('vendor.json') }}
        restore-keys: third-party-openharmony-

    - name: Run depsync
      run: |
        npm install depsync -g
        depsync

    # 用官方 Action 代替手工下载
    - name: Setup OpenHarmony SDK
      uses: openharmony-rs/setup-ohos-sdk@v0.2
      with:
        version: '5.0.3'     # 对应 API 15
        cache: true

    # Action 会自动把 OHOS_SDK_NATIVE 注入到 GITHUB_ENV，无需手动 echo
    - name: Configure SDK Path
      run: |
        cd ohos
        echo "sdk.dir=${OHOS_SDK_NATIVE}" > local.properties
        echo "OHOS_BASE_SDK_HOME=${OHOS_SDK_NATIVE}" >> local.properties

    - name: Setup .npmrc for OpenHarmony
      run: |
        echo "@ohos:registry=https://repo.harmonyos.com/npm/" >> $HOME/.npmrc
        echo "registry=https://registry.npmjs.org/" >> $HOME/.npmrc

    - name: Install ohpm
      run: |
        mkdir -p $HOME/ohpm
        cd $HOME/ohpm
        curl -L https://contentcenter-vali-drcn.dbankcdn.cn/pvt_2/DeveloperAlliance_package_901_9/81/v3/4ohpm1cli-darwin-x64-5.0.3.140.tgz -o ohpm.tgz || echo "Download failed, will use direct hvigorw"
        if [ -f "ohpm.tgz" ]; then
          tar -xzf ohpm.tgz
          echo "$HOME/ohpm/bin" >> $GITHUB_PATH
        fi

    - name: Install Dependencies & Build
      run: |
        cd ohos
        chmod +x hvigorw
        export PATH="$HOME/ohpm/bin:$PATH"
        if command -v ohpm &> /dev/null; then
          ohpm install --all
        fi
        ./hvigorw assembleHap --mode module -p module=hello2d -p product=default --stacktrace

    - name: Job Failed
      if: ${{ failure() }}
      uses: actions/upload-artifact@v4
      with:
        name: openharmony_build
        path: ohos/out
