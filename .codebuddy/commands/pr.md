---
description: 提交 PR - 自动识别新建或追加提交
---

# 提交 PR

严格按以下步骤顺序执行。

---

## 前置检查

### 检查是否已有开启的 PR

```bash
git branch --show-current
gh pr list --head "$(git branch --show-current)" --state open --json number,url
```

根据结果选择模式：

| 当前分支 | 已有开启的 PR | 模式 |
|----------|---------------|------|
| main | - | **新建模式** |
| 非 main | 有 | **追加模式** |
| 非 main | 无 | **新建模式** |

---

## 第一步：确定提交范围

```bash
git status --porcelain
```

输出格式说明：
- 第一列：暂存区状态（A=新增, M=修改, D=删除, R=重命名, 空格=未暂存）
- 第二列：工作区状态（M=修改, D=删除, ?=未跟踪, 空格=无变更）
- 示例：`M  file.txt`（已暂存修改），` M file.txt`（未暂存修改），`?? file.txt`（未跟踪）

根据状态判断：

| 暂存区 | 工作区（含未跟踪） | 处理方式 | 提交范围 |
|--------|-------------------|----------|----------|
| 有内容 | 有内容 | 询问用户：局部提交（仅暂存区内容），还是全部提交 | 用户选择 |
| 有内容 | 无内容 | 直接使用暂存区内容 | 全部提交 |
| 无内容 | 有内容 | 使用 `git add .` 添加全部变更 | 全部提交 |
| 无内容 | 无内容 | 提示无变更可提交，终止流程 | - |

**注意**：未跟踪文件（`??`）属于"工作区有内容"。

记录本步骤确定的**提交范围**（全部提交 / 局部提交）。若为**局部提交**，同时记录**暂存区文件列表**。

---

## 第二步：格式化代码

```bash
./codeformat.sh
```

忽略输出的报错信息，只要运行就会完成格式化。

格式化后根据第一步确定的提交范围处理：

| 提交范围 | 处理方式 |
|----------|----------|
| 全部提交 | 执行 `git add .` 将所有变更（包括格式化修改）加入暂存区 |
| 局部提交 | 检查第一步记录的暂存区文件是否被格式化修改，如有则重新加入暂存区（`git add {文件}`），忽略其他文件的格式化修改 |

---

## 第三步：生成提交信息

查看将要提交的内容：

```bash
git diff --cached
```

根据变更内容生成**Commit 信息**（英语，120 字符内，以句号结尾，侧重描述用户可感知的变化）。

---

## 第四步：提交并推送

**直接执行，无需确认。**

### 追加模式

```bash
git commit -m "{Commit 信息}"
git push
```

输出：

```
**Commit**：{Commit 信息}

**PR 链接**：{PR 链接}（已追加提交）
```

### 新建模式

生成以下信息：

- **分支名称**：`feature/{username}_模块名` 或 `bugfix/{username}_模块名`（`{username}` 为 GitHub 用户 ID 全小写，模块名用下划线连接，最多两个单词）
- **PR 描述**：中文，简要说明变更内容和目的

```bash
git checkout -b {分支名称}
git commit -m "{Commit 信息}"
git push -u origin {分支名称}
gh pr create --title "{Commit 信息}" --body "{PR 描述}"
```

输出：

```
**PR 标题**：{Commit 信息}

**PR 描述**：{PR 描述}

**PR 链接**：{PR 链接}（新建）
```

---

## 重要限制

- **禁止** force push
